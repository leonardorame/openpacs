--
-- PostgreSQL database dump
--

-- Started on 2013-03-27 15:47:41 ART

SET statement_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = off;
SET check_function_bodies = false;
SET client_min_messages = warning;
SET escape_string_warning = off;

CREATE DATABASE openpacs WITH TEMPLATE = template0 ENCODING = 'UTF8' LC_COLLATE = 'C' LC_CTYPE = 'C';

\connect openpacs

--
-- TOC entry 618 (class 2612 OID 23958)
-- Name: plpgsql; Type: PROCEDURAL LANGUAGE; Schema: -; Owner: postgres
--

CREATE PROCEDURAL LANGUAGE plpgsql;


ALTER PROCEDURAL LANGUAGE plpgsql OWNER TO postgres;

SET search_path = public, pg_catalog;

--
-- TOC entry 503 (class 1247 OID 68857)
-- Dependencies: 3 142
-- Name: imagetosend; Type: TYPE; Schema: public; Owner: postgres
--

--
-- TOC entry 497 (class 1247 OID 68846)
-- Dependencies: 3
-- Name: status_; Type: TYPE; Schema: public; Owner: postgres
--

CREATE TYPE status_ AS ENUM (
    'scheduled',
    'completed',
    'dictated',
    'cancelled',
    'finalized'
);


ALTER TYPE public.status_ OWNER TO postgres;


--
-- TOC entry 208 (class 1255 OID 113881)
-- Dependencies: 618 3
-- Name: clean_patient_records_withnone_image(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION clean_patient_records_withnone_image() RETURNS character varying
    LANGUAGE plpgsql
    AS $$

declare RPatient record;
declare RStudy record;
declare RSeries record;
begin

  delete from image where idseries not in (select idseries from series);
  delete from series where idseries not in (select idseries from image);
  delete from series where idstudy not in (select idstudy from study);
  delete from study where idstudy not in (select idstudy from series);
  --delete from patient where idpatient not in (select idpatient from study);
  --delete from patient where idpatient not in (select idpatient from study) and patientname like '%|%' and patientname not like '%null%';
  for RPatient in ( 
		    select p.idpatient from patient p 
		    join study st on p.idpatient=st.idpatient
                    join series s on st.idstudy=s.idstudy
                    where s.idseries not in
                    (
                     select idseries from image
                    )
                     and p.patientid like '%null%'
                   ) 
  LOOP
		for RStudy in (select st.idstudy from study st where st.idpatient=RPatient.idpatient) 
		LOOP
			for RSeries in (select s.idseries from series s where s.idstudy=RStudy.idstudy)
			LOOP
			delete from series where idseries=RSeries.idseries;
			END LOOP;
                delete from study where idstudy=RStudy.idstudy;	
		END LOOP;
  delete from patient where idpatient=RPatient.idpatient; 
  END LOOP;
    return 'DONE';    
end;
$$;


ALTER FUNCTION public.clean_patient_records_withnone_image() OWNER TO postgres;

--
-- TOC entry 211 (class 1255 OID 113879)
-- Dependencies: 3 618
-- Name: clean_patient_records_withnone_study_series(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION clean_patient_records_withnone_study_series() RETURNS character varying
    LANGUAGE plpgsql
    AS $$

declare RPatient record;
declare RStudy record;
declare RSeries record;
begin
  delete from image where idseries not in (select idseries from series);
  delete from series where idseries not in (select idseries from image);
  delete from series where idstudy not in (select idstudy from study);
  delete from study where idstudy not in (select idstudy from series);
  --delete from patient where idpatient not in (select idpatient from study);
  --delete from patient where idpatient not in (select idpatient from study) and patientname like '%|%' and patientname not like '%null%';

  for RPatient in (
                   select p.idpatient from patient p 
		   where p.idpatient not in
                   (
                    select idpatient from study
                   ) 
                   and patientid like '%null%'                    
                  ) 
  LOOP
		for RStudy in (select st.idstudy from study st where st.idpatient=RPatient.idpatient) 
		LOOP
			for RSeries in (select s.idseries from series s where s.idstudy=RStudy.idstudy)
			LOOP
			delete from series where idseries=RSeries.idseries;
			END LOOP;
                delete from study where idstudy=RStudy.idstudy;	
		END LOOP;
  delete from patient where idpatient=RPatient.idpatient; 
  END LOOP;
    return 'DONE';    
end;
$$;


ALTER FUNCTION public.clean_patient_records_withnone_study_series() OWNER TO postgres;


CREATE FUNCTION storeimage(patientbirthdate_ date, patientbirthtime_ time without time zone, patientsex_ character varying, patientname_ character varying, patientid_ character varying, otherpatientids_ character varying, otherpatientnames_ character varying, ethnicgroup_ character varying, patientage_ character varying, patientsize_ character varying, patientweight_ character varying, occupation_ character varying, studydate_ date, studytime_ character varying, studyid_ character varying, studydescription_ character varying, institutionname_ character varying, modality_ character varying, modalityaetitle_ character varying, nameofphysiciansreadingstudy_ character varying, accessionnumber_ character varying, referringphysiciansname_ character varying, studyinstanceuid_ character varying, seriesnumber_ character varying, seriesinstanceuid_ character varying, sopinstanceuid_ character varying, seriesdate_ date, seriestime_ time without time zone, seriesdescription_ character varying, bodypartexamined_ character varying, protocolname_ character varying, operatorsname_ character varying, performingphysiciansname_ character varying, rows_ integer, columns_ integer, filesizebytes_ integer, contentlabel_ character varying, instancenumber_ character varying, imagetype_ character varying, sopclassuid_ character varying, acquisitiondate_ date, acquisitiontime_ time without time zone, contentdate_ date, contenttime_ time without time zone, acquisitionnumber_ character varying, acr_nema_imageposition_ character varying, imagepositionpatient_ character varying, imageorientationpatient_ character varying, frameofreferenceuid_ character varying, slicelocation_ character varying, numberofframes_ character varying, image_ character varying, patientposition_ character varying) RETURNS character varying
    LANGUAGE plpgsql
    AS $$
DECLARE
  FunctResult varchar(255);
  IdPatient_ integer;
  lPatientId varchar(255);
  lPostPatientId varchar(255); 
  a integer;
  lPatientName varchar(255);
  lSeqPatientId integer;
  lIdPatientExist integer;
  IdStudy_ Integer;
  IdSeries_ Integer;
  IdImage_ integer;
  OLDImage_ varchar(255);
  study_time time without time zone;
BEGIN

  if( studytime_='') then
  study_time = now()::time;
  else
  study_time=studytime_;
  end if;
  -- Inserta paciente
  -- select IdPatient from patient 
  -- where PatientID=PatientID_ into IdPatient_;
  RAISE NOTICE '------Starting Patient section---------';
   
  if (PatientID_='') then
  RAISE NOTICE 'Parameter patientid was not provided';
     select nextval('public."patient_patientid_seq"') into a;
     select currval('public."patient_patientid_seq"') into lSeqPatientId;
     lPatientID=lSeqPatientId||'|'||'null' ||'|' || ModalityAetitle_;        
     RAISE NOTICE 'New patientid autogenerated [%]',lPatientID;
  else
  RAISE NOTICE 'Parameter PatientID provided [%] ',PatientID_;
     lPatientID=PatientID_;
  end if;  

  RAISE NOTICE 'Searching patient with PatientID [%]',lPatientID;
  select into IdPatient_,lPatientName idpatient,patientname
  from patient
  --where PatientID=PatientID_;
  where PatientID=lPatientID;
  
   
  if(IdPatient_ is null) then
    --values(PatientBirthDate_, PatientBirthTime_, PatientSex_, PatientName_, PatientID_, 
    RAISE NOTICE 'Patient not found. New Patient will be created. Autogenerated PatientID: [%]',lPatientID;
    insert into patient(
      PatientBirthDate, PatientBirthTime, PatientSex, PatientName, PatientID, 
      OtherPatientIDs, OtherPatientNames, EthnicGroup, PatientAge, PatientSize,
      PatientWeight, Occupation)   
    values(PatientBirthDate_, PatientBirthTime_, PatientSex_, PatientName_, lPatientID, 
      OtherPatientIDs_, OtherPatientNames_, EthnicGroup_, PatientAge_, PatientSize_,
      PatientWeight_, Occupation_);
    IdPatient_ = currval(pg_get_serial_sequence('patient', 'idpatient'));
  else
     if (lPatientName=patientname_) then
       RAISE NOTICE 'Patient [%] found. Updating patient info: [%]',lPatientName,lPatientID;
       UPDATE patient
       SET patientbirthdate=PatientBirthDate_, patientbirthtime=PatientBirthTime_, patientsex=PatientSex_, 
       patientname=PatientName_, otherpatientids=OtherPatientIDs_, otherpatientnames=OtherPatientNames_, 
       ethnicgroup= EthnicGroup_, patientage=PatientAge_, patientsize=PatientSize_, patientweight=PatientWeight_, 
       occupation=Occupation_
       --where PatientID=PatientID_;
         where PatientID=lPatientID;    
    else
          -- Se cambia el IdPatient.
          -- PIW= Patient Identification Warning
	  --lPostPatientId=PatientID_||'|'|| ModalityAetitle_||'|'||studyinstanceuid_;
       RAISE NOTICE 'Patient found, but patientname seems to be differents: PatientName found: [%] Paramater PatientName [%] ',lPatientName,PatientName_;
       select nextval('public."patient_patientid_seq"') into a;
       select currval('public."patient_patientid_seq"') into lSeqPatientId;
       lPostPatientId=lPatientID||'|'|| ModalityAetitle_||'|'||studyinstanceuid_;      
       lPatientId=lSeqPatientId||'|'||lPostPatientId;
       RAISE NOTICE 'Two new patientid will be generated';
       RAISE NOTICE '[%] ',lPostPatientId;          
       RAISE NOTICE '[%]',lPatientId;
       select idpatient from patient where patientid like '%'||lPostPatientId limit 1 into  lIdPatientExist;
       
         if (lIdPatientExist is null) then
         RAISE NOTICE 'No idpatient was found with patientid [%]',lPostPatientId;
         RAISE NOTICE 'Creating new patient info with patientid [%]',lPostPatientId;
            insert into patient(
            PatientBirthDate, PatientBirthTime, PatientSex, PatientName, PatientID, 
            OtherPatientIDs, OtherPatientNames, EthnicGroup, PatientAge, PatientSize,
            PatientWeight, Occupation)
            values(PatientBirthDate_, PatientBirthTime_, PatientSex_, PatientName_, lPatientId, 
            lIdPatientExist, OtherPatientNames_, EthnicGroup_, PatientAge_, PatientSize_,
            PatientWeight_, Occupation_);
            IdPatient_ = currval(pg_get_serial_sequence('patient', 'idpatient'));           
         else
         RAISE NOTICE 'Updating patient info. Idpatient [%] found with patientid [%]',lIdPatientExist,lPostPatientId;
            IdPatient_=lIdPatientExist;	
	 end if;
          --IdPatient_ = currval(pg_get_serial_sequence('patient', 'idpatient')); 		
    end if;      
  end if;

  RAISE NOTICE '------Starting Study section---------';
  -- Inserts study
  select IdStudy from study
    where (StudyInstanceUID = StudyInstanceUID_) 
  into IdStudy_;
  
  if(IdStudy_ is null) then
  RAISE NOTICE 'idstudy not found with StudyInstanceUID [%]',StudyInstanceUID_;
  RAISE NOTICE 'Creating study [%]',StudyInstanceUID_;
    insert into study(
      StudyDate, StudyTime, StudyId, StudyDescription,
      NameOfPhysiciansReadingStudy, AccessionNumber,
      PerformingPhysiciansName, ReferringPhysiciansName, StudyInstanceUID, Status, IdPatient, InstitutionName,created_time)
    values(StudyDate_, study_time, StudyId_, StudyDescription_,   
    NameOfPhysiciansReadingStudy_, AccessionNumber_,
      PerformingPhysiciansName_,ReferringPhysiciansName_,StudyInstanceUID_,
      'completed', IdPatient_, -- Al recibir una im√°gen siempre el estado es completed
      InstitutionName_,now()
      );   
     IdStudy_ = currval(pg_get_serial_sequence('study', 'idstudy'));
   else
   RAISE NOTICE 'Updating study info. Idstudy [%] found with StudyInstanceUID [%]',IdStudy_,StudyInstanceUID_;
     UPDATE study
  SET  studydate=StudyDate_, studytime=study_time, studydescription=StudyDescription_, 
       nameofphysiciansreadingstudy=NameOfPhysiciansReadingStudy_, accessionnumber=AccessionNumber_, 
       performingphysiciansname=PerformingPhysiciansName_, referringphysiciansname=ReferringPhysiciansName_,
       studyinstanceuid=StudyInstanceUID, status='completed',idpatient=IdPatient_, institutionname=InstitutionName_,created_time=now()
       where IdStudy = IdStudy_;   
   end if;


 RAISE NOTICE '------Starting Serie section---------';
   -- Inserts series
   select IdSeries from series
     where SeriesInstanceUID=SeriesInstanceUID_ into IdSeries_;
   if(IdSeries_ is null) then
   RAISE NOTICE 'idseries not found with SeriesInstanceUID [%]',StudyInstanceUID_;
   RAISE NOTICE 'Creating new serie [%]',SeriesInstanceUID_;
     insert into series(
       SeriesNumber, SeriesInstanceUID, SeriesDate,
       SeriesTime, SeriesDescription, BodyPartExamined, ProtocolName,
       OperatorsName,
       ContentLabel, IdStudy,
       Modality, ModalityAetitle) 
     values(SeriesNumber_, SeriesInstanceUID_, SeriesDate_,
       SeriesTime_, SeriesDescription_, BodyPartExamined_,ProtocolName_,
       OperatorsName_,
       ContentLabel_,
       IdStudy_,
       Modality_,
       ModalityAetitle_);
     IdSeries_ = currval(pg_get_serial_sequence('series', 'idseries'));
     else
      RAISE NOTICE 'Updating series info.Idseries [%] found with SeriesInstanceUID [%]',IdSeries_,SeriesInstanceUID_;
     UPDATE series
   SET seriesnumber=SeriesNumber_,seriesdate=SeriesDate_, 
       seriestime=SeriesTime_, seriesdescription=SeriesDescription_, bodypartexamined=BodyPartExamined_,
       protocolname=ProtocolName_, operatorsname=OperatorsName_, contentlabel=ContentLabel_,
       idstudy=IdStudy_, Modality=Modality_, ModalityAetitle=ModalityAetitle_
       where SeriesInstanceUID=SeriesInstanceUID_; 
   end if;

 RAISE NOTICE '------Starting Image section---------';
  select IdImage from image
    where (sopinstanceuid = sopinstanceuid_) 
  into IdImage_;

  if (IdImage_ is null) then
   -- Inserta la imagen
   RAISE NOTICE 'idimage not found with sopinstanceuid [%]',sopinstanceuid_;
   RAISE NOTICE 'Creating new image [%]',sopinstanceuid_;
  insert into image(ImagePath,ThumbnailPath,SOPInstanceUID,IdSeries,Rows,
    Columns,FileSizeBytes,DateCreated,
    InstanceNumber, ImageType, SOPClassUID,
    AcquisitionDate, AcquisitionTime, ContentDate, ContentTime,
    AcquisitionNumber, Acr_Nema_ImagePosition,
    ImagePositionPatient, ImageOrientationPatient,
    FrameOfReferenceUID, SliceLocation,  NumberOfFrames, PatientPosition,status 
    ) 
  values(Image_, Image_||'.jpg', SOPInstanceUID_, IdSeries_, Rows_, 
    Columns_, FileSizeBytes_, current_timestamp, 
    InstanceNumber_, ImageType_, SOPClassUID_,
    AcquisitionDate_, AcquisitionTime_, ContentDate_, ContentTime_,
    AcquisitionNumber_, Acr_Nema_ImagePosition_,
    ImagePositionPatient_, ImageOrientationPatient_,
    FrameOfReferenceUID_, SliceLocation_,  NumberOfFrames_, PatientPosition_,'existing'
    );
    else
    RAISE NOTICE 'Updating image info. Idimage [%] found with sopinstanceuid [%]',IdImage_,sopinstanceuid_;
    UPDATE image
    SET ImagePath=Image_, ThumbnailPath=Image_||'.jpg',SOPInstanceUID=SOPInstanceUID_,IdSeries=IdSeries_, Rows=Rows_,
    Columns=Columns_, FileSizeBytes=FileSizeBytes_, DateCreated=current_timestamp,
    InstanceNumber=InstanceNumber_, AcquisitionTime=AcquisitionTime_,ContentDate=ContentDate_, ContentTime=ContentTime_,
    AcquisitionNumber=AcquisitionNumber_, Acr_Nema_ImagePosition=Acr_Nema_ImagePosition_,
    ImagePositionPatient=ImagePositionPatient_, ImageOrientationPatient=ImageOrientationPatient_,
    FrameOfReferenceUID=FrameOfReferenceUID_, SliceLocation=SliceLocation_,  NumberOfFrames=NumberOfFrames_, PatientPosition=PatientPosition_,status='existing'
    where sopinstanceuid = sopinstanceuid_  ; 
   end if;

  RAISE NOTICE 'Leaving PSQL procedure... ';
  FunctResult='DONE';
  RETURN FunctResult;    

  --EXCEPTION WHEN SQLSTATE '22001' THEN
  --RAISE NOTICE 'SQl error';
  
  EXCEPTION WHEN OTHERS THEN   
  begin
  RAISE NOTICE '-------SQL ERROR ---------';  
  RAISE NOTICE 'SQLState    [%],', SQLSTATE;
  RAISE NOTICE 'SQL Message [%],',SQLERRM;
  RAISE NOTICE '-------SQL ERROR ---------';
  RETURN 'ERROR '|| SQLSTATE ||' '||SQLERRM;
  end;
END;
$$;


ALTER FUNCTION public.storeimage(patientbirthdate_ date, patientbirthtime_ time without time zone, patientsex_ character varying, patientname_ character varying, patientid_ character varying, otherpatientids_ character varying, otherpatientnames_ character varying, ethnicgroup_ character varying, patientage_ character varying, patientsize_ character varying, patientweight_ character varying, occupation_ character varying, studydate_ date, studytime_ character varying, studyid_ character varying, studydescription_ character varying, institutionname_ character varying, modality_ character varying, modalityaetitle_ character varying, nameofphysiciansreadingstudy_ character varying, accessionnumber_ character varying, referringphysiciansname_ character varying, studyinstanceuid_ character varying, seriesnumber_ character varying, seriesinstanceuid_ character varying, sopinstanceuid_ character varying, seriesdate_ date, seriestime_ time without time zone, seriesdescription_ character varying, bodypartexamined_ character varying, protocolname_ character varying, operatorsname_ character varying, performingphysiciansname_ character varying, rows_ integer, columns_ integer, filesizebytes_ integer, contentlabel_ character varying, instancenumber_ character varying, imagetype_ character varying, sopclassuid_ character varying, acquisitiondate_ date, acquisitiontime_ time without time zone, contentdate_ date, contenttime_ time without time zone, acquisitionnumber_ character varying, acr_nema_imageposition_ character varying, imagepositionpatient_ character varying, imageorientationpatient_ character varying, frameofreferenceuid_ character varying, slicelocation_ character varying, numberofframes_ character varying, image_ character varying, patientposition_ character varying) OWNER TO postgres;

SET default_tablespace = '';

SET default_with_oids = false;


CREATE TABLE config (
    variablename character varying(50) NOT NULL,
    variablevalue character varying(120),
    datatype character varying(50) DEFAULT 'STRING'::character varying,
    observation text,
    systemoptions boolean DEFAULT false,
    parametergroup character varying
);


ALTER TABLE public.config OWNER TO postgres;

--
-- TOC entry 155 (class 1259 OID 68946)
-- Dependencies: 1961 3
-- Name: externalsystem; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE externalsystem (
    idexternalsystem integer NOT NULL,
    name character varying(30),
    ip character varying(15),
    port integer,
    aetitle character varying(25),
    defaultsystem boolean DEFAULT false,
    external_system_type character varying(50),
    service character varying(20)
);


ALTER TABLE public.externalsystem OWNER TO postgres;

--
-- TOC entry 154 (class 1259 OID 68944)
-- Dependencies: 155 3
-- Name: externalsystem_idexternalsystem_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE externalsystem_idexternalsystem_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.externalsystem_idexternalsystem_seq OWNER TO postgres;

--
-- TOC entry 2065 (class 0 OID 0)
-- Dependencies: 154
-- Name: externalsystem_idexternalsystem_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE externalsystem_idexternalsystem_seq OWNED BY externalsystem.idexternalsystem;


--
-- TOC entry 2066 (class 0 OID 0)
-- Dependencies: 154
-- Name: externalsystem_idexternalsystem_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('externalsystem_idexternalsystem_seq', 19, true);


--
-- TOC entry 152 (class 1259 OID 68918)
-- Dependencies: 3
-- Name: image; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE image (
    idimage integer NOT NULL,
    sopinstanceuid character varying(255),
    imagepath character varying(255),
    thumbnailpath character varying(255),
    idseries integer,
    rows integer,
    columns integer,
    datecreated timestamp without time zone,
    filesizebytes integer,
    instancenumber character varying(100),
    imagetype character varying(100),
    sopclassuid character varying(100),
    acquisitiondate date,
    acquisitiontime time without time zone,
    contentdate date,
    acquisitionnumber character varying(100),
    acr_nema_imageposition character varying(100),
    contenttime time without time zone,
    imagepositionpatient character varying(100),
    imageorientationpatient character varying(100),
    frameofreferenceuid character varying(100),
    slicelocation character varying(100),
    numberofframes character varying(100),
    patientposition character varying(100),
    status character varying(100),
    windowcenter integer,
    windowwidth integer
);


ALTER TABLE public.image OWNER TO postgres;

--
-- TOC entry 151 (class 1259 OID 68916)
-- Dependencies: 152 3
-- Name: image_idimage_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE image_idimage_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.image_idimage_seq OWNER TO postgres;

--
-- TOC entry 2067 (class 0 OID 0)
-- Dependencies: 151
-- Name: image_idimage_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE image_idimage_seq OWNED BY image.idimage;


--
-- TOC entry 2068 (class 0 OID 0)
-- Dependencies: 151
-- Name: image_idimage_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('image_idimage_seq', 35893, true);


--
-- TOC entry 146 (class 1259 OID 68873)
-- Dependencies: 497 3
-- Name: study; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE study (
    idstudy integer NOT NULL,
    studydate date,
    studytime time without time zone,
    studyid character varying(20),
    studydescription character varying(255),
    nameofphysiciansreadingstudy character varying(255),
    accessionnumber character varying(20),
    performingphysiciansname character varying(255),
    referringphysiciansname character varying(255),
    studyinstanceuid character varying(255),
    status status_,
    institutionname character varying(100),
    idpatient integer,
    created_time timestamp without time zone
);


ALTER TABLE public.study OWNER TO postgres;

--
-- TOC entry 174 (class 1259 OID 69086)
-- Dependencies: 1760 3
-- Name: institutions; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW institutions AS
    SELECT DISTINCT study.institutionname FROM study;


ALTER TABLE public.institutions OWNER TO postgres;

--
-- TOC entry 166 (class 1259 OID 69050)
-- Dependencies: 3
-- Name: keys; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE keys (
    keynumber character varying(100)
);


ALTER TABLE public.keys OWNER TO postgres;

--
-- TOC entry 173 (class 1259 OID 69082)
-- Dependencies: 1759 3
-- Name: modalityaetitles; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW modalityaetitles AS
    SELECT DISTINCT study.modalityaetitle FROM study;


ALTER TABLE public.modalityaetitles OWNER TO postgres;

--
-- TOC entry 165 (class 1259 OID 69044)
-- Dependencies: 3
-- Name: notificationrecipients; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE notificationrecipients (
    idnotificationrecipient integer NOT NULL,
    email character varying(100),
    recipientname character varying(100),
    lastnotification date
);


ALTER TABLE public.notificationrecipients OWNER TO postgres;

--
-- TOC entry 164 (class 1259 OID 69042)
-- Dependencies: 3 165
-- Name: notificationrecipients_idnotificationrecipient_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE notificationrecipients_idnotificationrecipient_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.notificationrecipients_idnotificationrecipient_seq OWNER TO postgres;

--
-- TOC entry 2069 (class 0 OID 0)
-- Dependencies: 164
-- Name: notificationrecipients_idnotificationrecipient_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE notificationrecipients_idnotificationrecipient_seq OWNED BY notificationrecipients.idnotificationrecipient;


--
-- TOC entry 2070 (class 0 OID 0)
-- Dependencies: 164
-- Name: notificationrecipients_idnotificationrecipient_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('notificationrecipients_idnotificationrecipient_seq', 1, false);


--
-- TOC entry 157 (class 1259 OID 68977)
-- Dependencies: 1963 1964 3
-- Name: pacs_user; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE pacs_user (
    id_user integer NOT NULL,
    user_name character varying(255) NOT NULL,
    password character varying(100),
    fullname character varying(255),
    administrator boolean DEFAULT false,
    email character varying(50),
    notificar boolean DEFAULT false
);


ALTER TABLE public.pacs_user OWNER TO postgres;

--
-- TOC entry 159 (class 1259 OID 68991)
-- Dependencies: 3
-- Name: pacs_user_data; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE pacs_user_data (
    id_user_data integer NOT NULL,
    nameparameter character varying(100) NOT NULL,
    valueparameter text,
    id_pacs_user integer NOT NULL,
    page_name character varying(50)
);


ALTER TABLE public.pacs_user_data OWNER TO postgres;

--
-- TOC entry 158 (class 1259 OID 68989)
-- Dependencies: 3 159
-- Name: pacs_user_data_id_user_data_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE pacs_user_data_id_user_data_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.pacs_user_data_id_user_data_seq OWNER TO postgres;

--
-- TOC entry 2071 (class 0 OID 0)
-- Dependencies: 158
-- Name: pacs_user_data_id_user_data_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE pacs_user_data_id_user_data_seq OWNED BY pacs_user_data.id_user_data;

--
-- TOC entry 2072 (class 0 OID 0)
-- Dependencies: 158
-- Name: pacs_user_data_id_user_data_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('pacs_user_data_id_user_data_seq', 5, true);


--
-- TOC entry 156 (class 1259 OID 68975)
-- Dependencies: 3 157
-- Name: pacs_user_id_user_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE pacs_user_id_user_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.pacs_user_id_user_seq OWNER TO postgres;

--
-- TOC entry 2073 (class 0 OID 0)
-- Dependencies: 156
-- Name: pacs_user_id_user_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE pacs_user_id_user_seq OWNED BY pacs_user.id_user;


--
-- TOC entry 2074 (class 0 OID 0)
-- Dependencies: 156
-- Name: pacs_user_id_user_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('pacs_user_id_user_seq', 10, true);


--
-- TOC entry 144 (class 1259 OID 68860)
-- Dependencies: 3
-- Name: patient; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE patient (
    idpatient integer NOT NULL,
    patientbirthdate date,
    patientbirthtime time without time zone,
    patientsex character varying(1),
    patientname character varying(255),
    patientid character varying(100),
    otherpatientids character varying(20),
    otherpatientnames character varying(255),
    ethnicgroup character varying(20),
    patientage character varying(20),
    patientsize character varying(20),
    patientweight character varying(20),
    occupation character varying(255)
);


ALTER TABLE public.patient OWNER TO postgres;

--
-- TOC entry 148 (class 1259 OID 68891)
-- Dependencies: 3
-- Name: series; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE series (
    idseries integer NOT NULL,
    seriesnumber character varying(100),
    seriesinstanceuid character varying(255),
    seriesdate date,
    seriestime time without time zone,
    seriesdescription character varying(255),
    bodypartexamined character varying(255),
    protocolname character varying(100),
    operatorsname character varying(255),
    contentlabel character varying(255),
    idstudy integer,
    modality character varying(2),
    modalityaetitle character varying(50),
    processed boolean
);


ALTER TABLE public.series OWNER TO postgres;

--
-- TOC entry 2075 (class 0 OID 0)
-- Dependencies: 148
-- Name: COLUMN series.processed; Type: COMMENT; Schema: public; Owner: postgres
--

COMMENT ON COLUMN series.processed IS 'Cuando este campo es "true" significa que la serie fue procesada por el Gateway alguna vez.';


--
-- TOC entry 179 (class 1259 OID 97396)
-- Dependencies: 1761 3
-- Name: patientStudies; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW "patientStudies" AS
    SELECT p.idpatient, p.patientid, p.patientname, p.patientbirthdate, p.patientage, p.patientweight, p.patientsex, s.idstudy, s.accessionnumber, s.modality, s.studydate, s.studydescription, (s.status)::character varying AS status, s.nameofphysiciansreadingstudy, s.referringphysiciansname, s.performingphysiciansname, count(*) AS cantimagenes FROM (((study s JOIN patient p ON ((s.idpatient = p.idpatient))) JOIN series se ON ((s.idstudy = se.idstudy))) JOIN image i ON ((se.idseries = i.idseries))) GROUP BY p.idpatient, p.patientid, p.patientname, p.patientbirthdate, p.patientage, p.patientweight, p.patientsex, s.idstudy, s.accessionnumber, s.modality, s.studydate, s.studydescription, s.status, s.nameofphysiciansreadingstudy, s.referringphysiciansname, s.performingphysiciansname;


ALTER TABLE public."patientStudies" OWNER TO postgres;

--
-- TOC entry 143 (class 1259 OID 68858)
-- Dependencies: 144 3
-- Name: patient_idpatient_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE patient_idpatient_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.patient_idpatient_seq OWNER TO postgres;

--
-- TOC entry 2076 (class 0 OID 0)
-- Dependencies: 143
-- Name: patient_idpatient_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE patient_idpatient_seq OWNED BY patient.idpatient;


--
-- TOC entry 2077 (class 0 OID 0)
-- Dependencies: 143
-- Name: patient_idpatient_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('patient_idpatient_seq', 3168, true);


--
-- TOC entry 180 (class 1259 OID 97424)
-- Dependencies: 3
-- Name: patient_patientid_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE patient_patientid_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.patient_patientid_seq OWNER TO postgres;

--
-- TOC entry 2078 (class 0 OID 0)
-- Dependencies: 180
-- Name: patient_patientid_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('patient_patientid_seq', 947, true);


--
-- TOC entry 150 (class 1259 OID 68907)
-- Dependencies: 3
-- Name: replacedimages; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE replacedimages (
    idreplacedimage integer NOT NULL,
    oldimage character varying(255),
    newimage character varying(255),
    idstudy integer,
    status character varying(50),
    creationdate timestamp without time zone,
    deleteddate timestamp without time zone
);


ALTER TABLE public.replacedimages OWNER TO postgres;

--
-- TOC entry 149 (class 1259 OID 68905)
-- Dependencies: 3 150
-- Name: replacedimages_idreplacedimage_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE replacedimages_idreplacedimage_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.replacedimages_idreplacedimage_seq OWNER TO postgres;

--
-- TOC entry 2079 (class 0 OID 0)
-- Dependencies: 149
-- Name: replacedimages_idreplacedimage_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE replacedimages_idreplacedimage_seq OWNED BY replacedimages.idreplacedimage;


--
-- TOC entry 2080 (class 0 OID 0)
-- Dependencies: 149
-- Name: replacedimages_idreplacedimage_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('replacedimages_idreplacedimage_seq', 2536, true);



--
-- TOC entry 172 (class 1259 OID 69077)
-- Dependencies: 1758 3
-- Name: serieImages; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW "serieImages" AS
    SELECT s.idseries, s.seriesnumber, s.seriesinstanceuid, s.seriesdate, s.seriestime, s.seriesdescription, s.bodypartexamined, s.protocolname, s.operatorsname, s.contentlabel, s.idstudy, count(s.idseries) AS cantimages FROM (series s JOIN image i ON ((i.idseries = s.idseries))) GROUP BY s.idseries, s.seriesnumber, s.seriesinstanceuid, s.seriesdate, s.seriestime, s.seriesdescription, s.bodypartexamined, s.protocolname, s.operatorsname, s.contentlabel, s.idstudy;


ALTER TABLE public."serieImages" OWNER TO postgres;

--
-- TOC entry 147 (class 1259 OID 68889)
-- Dependencies: 148 3
-- Name: series_idseries_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE series_idseries_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.series_idseries_seq OWNER TO postgres;

--
-- TOC entry 2088 (class 0 OID 0)
-- Dependencies: 147
-- Name: series_idseries_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE series_idseries_seq OWNED BY series.idseries;


--
-- TOC entry 2089 (class 0 OID 0)
-- Dependencies: 147
-- Name: series_idseries_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('series_idseries_seq', 5400, true);


--
-- TOC entry 145 (class 1259 OID 68871)
-- Dependencies: 146 3
-- Name: study_idstudy_seq; Type: SEQUENCE; Schema: public; Owner: postgres
--

CREATE SEQUENCE study_idstudy_seq
    START WITH 1
    INCREMENT BY 1
    NO MAXVALUE
    NO MINVALUE
    CACHE 1;


ALTER TABLE public.study_idstudy_seq OWNER TO postgres;

--
-- TOC entry 2090 (class 0 OID 0)
-- Dependencies: 145
-- Name: study_idstudy_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: postgres
--

ALTER SEQUENCE study_idstudy_seq OWNED BY study.idstudy;

--
-- TOC entry 2091 (class 0 OID 0)
-- Dependencies: 145
-- Name: study_idstudy_seq; Type: SEQUENCE SET; Schema: public; Owner: postgres
--

SELECT pg_catalog.setval('study_idstudy_seq', 2943, true);

ALTER TABLE ONLY externalsystem ALTER COLUMN idexternalsystem SET DEFAULT nextval('externalsystem_idexternalsystem_seq'::regclass);


--
-- TOC entry 1957 (class 2604 OID 68921)
-- Dependencies: 152 151 152
-- Name: idimage; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY image ALTER COLUMN idimage SET DEFAULT nextval('image_idimage_seq'::regclass);



--
-- TOC entry 1962 (class 2604 OID 68980)
-- Dependencies: 156 157 157
-- Name: id_user; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY pacs_user ALTER COLUMN id_user SET DEFAULT nextval('pacs_user_id_user_seq'::regclass);


--
-- TOC entry 1965 (class 2604 OID 68994)
-- Dependencies: 158 159 159
-- Name: id_user_data; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY pacs_user_data ALTER COLUMN id_user_data SET DEFAULT nextval('pacs_user_data_id_user_data_seq'::regclass);


--
-- TOC entry 1953 (class 2604 OID 68863)
-- Dependencies: 144 143 144
-- Name: idpatient; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY patient ALTER COLUMN idpatient SET DEFAULT nextval('patient_idpatient_seq'::regclass);


--
-- TOC entry 1956 (class 2604 OID 68910)
-- Dependencies: 150 149 150
-- Name: idreplacedimage; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY replacedimages ALTER COLUMN idreplacedimage SET DEFAULT nextval('replacedimages_idreplacedimage_seq'::regclass);


-- TOC entry 1955 (class 2604 OID 68894)
-- Dependencies: 147 148 148
-- Name: idseries; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY series ALTER COLUMN idseries SET DEFAULT nextval('series_idseries_seq'::regclass);


--
-- TOC entry 1954 (class 2604 OID 68876)
-- Dependencies: 145 146 146
-- Name: idstudy; Type: DEFAULT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY study ALTER COLUMN idstudy SET DEFAULT nextval('study_idstudy_seq'::regclass);


--
-- TOC entry 1986 (class 2604 OID 141175)
-- Dependencies: 187 186 187
-- Name: orden; Type: DEFAULT; Schema: public; Owner: postgres
--


SET search_path = public, pg_catalog;

--
-- TOC entry 2006 (class 2606 OID 68943)
-- Dependencies: 153 153
-- Name: config_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY config
    ADD CONSTRAINT config_pkey PRIMARY KEY (variablename);


--
-- TOC entry 2008 (class 2606 OID 68952)
-- Dependencies: 155 155
-- Name: externalsystem_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY externalsystem
    ADD CONSTRAINT externalsystem_pkey PRIMARY KEY (idexternalsystem);

--
-- TOC entry 2002 (class 2606 OID 68926)
-- Dependencies: 152 152
-- Name: image_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY image
    ADD CONSTRAINT image_pkey PRIMARY KEY (idimage);

--
-- TOC entry 2004 (class 2606 OID 68928)
-- Dependencies: 152 152
-- Name: image_sopinstanceuid_key; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY image
    ADD CONSTRAINT image_sopinstanceuid_key UNIQUE (sopinstanceuid);

--
-- TOC entry 2014 (class 2606 OID 68999)
-- Dependencies: 159 159
-- Name: pacs_user_data_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY pacs_user_data
    ADD CONSTRAINT pacs_user_data_pkey PRIMARY KEY (id_user_data);

--
-- TOC entry 2010 (class 2606 OID 68986)
-- Dependencies: 157 157
-- Name: pacs_user_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY pacs_user
    ADD CONSTRAINT pacs_user_pkey PRIMARY KEY (id_user);


--
-- TOC entry 1990 (class 2606 OID 97387)
-- Dependencies: 144 144
-- Name: patient_patientid_key; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY patient
    ADD CONSTRAINT patient_patientid_key UNIQUE (patientid);

--
-- TOC entry 1992 (class 2606 OID 68868)
-- Dependencies: 144 144
-- Name: patient_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY patient
    ADD CONSTRAINT patient_pkey PRIMARY KEY (idpatient);

--
-- TOC entry 2000 (class 2606 OID 68915)
-- Dependencies: 150 150
-- Name: replacedimages_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY replacedimages
    ADD CONSTRAINT replacedimages_pkey PRIMARY KEY (idreplacedimage);

--
-- TOC entry 1998 (class 2606 OID 68899)
-- Dependencies: 148 148
-- Name: series_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY series
    ADD CONSTRAINT series_pkey PRIMARY KEY (idseries);


--
-- TOC entry 1994 (class 2606 OID 68881)
-- Dependencies: 146 146
-- Name: study_pkey; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY study
    ADD CONSTRAINT study_pkey PRIMARY KEY (idstudy);


--
-- TOC entry 1996 (class 2606 OID 68883)
-- Dependencies: 146 146
-- Name: study_studyinstanceuid_key; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY study
    ADD CONSTRAINT study_studyinstanceuid_key UNIQUE (studyinstanceuid);


--
-- TOC entry 2012 (class 2606 OID 68988)
-- Dependencies: 157 157
-- Name: user_name_key_unique; Type: CONSTRAINT; Schema: public; Owner: postgres; Tablespace: 
--

ALTER TABLE ONLY pacs_user
    ADD CONSTRAINT user_name_key_unique UNIQUE (user_name);

--
-- TOC entry 2031 (class 2606 OID 68929)
-- Dependencies: 152 1997 148
-- Name: image_idseries_fkey; Type: FK CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY image
    ADD CONSTRAINT image_idseries_fkey FOREIGN KEY (idseries) REFERENCES series(idseries);


--
-- TOC entry 2032 (class 2606 OID 69000)
-- Dependencies: 2009 157 159
-- Name: pacs_user_data_id_pacs_user_fkey; Type: FK CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY pacs_user_data
    ADD CONSTRAINT pacs_user_data_id_pacs_user_fkey FOREIGN KEY (id_pacs_user) REFERENCES pacs_user(id_user);


--
-- TOC entry 2030 (class 2606 OID 68900)
-- Dependencies: 148 1993 146
-- Name: series_idstudy_fkey; Type: FK CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY series
    ADD CONSTRAINT series_idstudy_fkey FOREIGN KEY (idstudy) REFERENCES study(idstudy);


--
-- TOC entry 2029 (class 2606 OID 68884)
-- Dependencies: 146 144 1991
-- Name: study_idpatient_fkey; Type: FK CONSTRAINT; Schema: public; Owner: postgres
--

ALTER TABLE ONLY study
    ADD CONSTRAINT study_idpatient_fkey FOREIGN KEY (idpatient) REFERENCES patient(idpatient);

--
-- TOC entry 2064 (class 0 OID 0)
-- Dependencies: 3
-- Name: public; Type: ACL; Schema: -; Owner: postgres
--

REVOKE ALL ON SCHEMA public FROM PUBLIC;
REVOKE ALL ON SCHEMA public FROM postgres;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO PUBLIC;


-- Completed on 2013-03-27 15:47:42 ART

--
-- PostgreSQL database dump complete
--

